import os

import infra.basetest


class TestFwts(infra.basetest.BRTest):
    config = \
        """
        LINGMO_aarch64=y
        LINGMO_TOOLCHAIN_EXTERNAL=y
        LINGMO_TARGET_GENERIC_GETTY_PORT="ttyAMA0"
        LINGMO_TARGET_ROOTFS_EXT2=y
        LINGMO_TARGET_ROOTFS_EXT2_4=y
        # LINGMO_TARGET_ROOTFS_TAR is not set
        LINGMO_TARGET_ROOTFS_EXT2_SIZE="128M"
        LINGMO_ROOTFS_POST_IMAGE_SCRIPT="board/qemu/aarch64-sbsa/assemble-flash-images support/scripts/genimage.sh"
        LINGMO_ROOTFS_POST_SCRIPT_ARGS="-c board/qemu/aarch64-sbsa/genimage.cfg"
        LINGMO_LINUX_KERNEL=y
        LINGMO_LINUX_KERNEL_CUSTOM_VERSION=y
        LINGMO_LINUX_KERNEL_CUSTOM_VERSION_VALUE="6.6.28"
        LINGMO_LINUX_KERNEL_NEEDS_HOST_OPENSSL=y
        LINGMO_LINUX_KERNEL_USE_ARCH_DEFAULT_CONFIG=y
        LINGMO_TARGET_EDK2=y
        LINGMO_TARGET_EDK2_PLATFORM_QEMU_SBSA=y
        LINGMO_TARGET_GRUB2=y
        LINGMO_TARGET_GRUB2_ARM64_EFI=y
        LINGMO_TARGET_ARM_TRUSTED_FIRMWARE=y
        LINGMO_TARGET_ARM_TRUSTED_FIRMWARE_CUSTOM_VERSION=y
        LINGMO_TARGET_ARM_TRUSTED_FIRMWARE_CUSTOM_VERSION_VALUE="v2.9"
        LINGMO_TARGET_ARM_TRUSTED_FIRMWARE_PLATFORM="qemu_sbsa"
        LINGMO_TARGET_ARM_TRUSTED_FIRMWARE_FIP=y
        LINGMO_PACKAGE_FWTS=y
        LINGMO_PACKAGE_FWTS_EFI_RUNTIME_MODULE=y
        LINGMO_PACKAGE_HOST_GENIMAGE=y
        LINGMO_PACKAGE_HOST_DOSFSTOOLS=y
        LINGMO_PACKAGE_HOST_MTOOLS=y
        """

    def test_run(self):
        hda = os.path.join(self.builddir, "images", "disk.img")
        flash0 = os.path.join(self.builddir, "images", "SBSA_FLASH0.fd")
        flash1 = os.path.join(self.builddir, "images", "SBSA_FLASH1.fd")
        self.emulator.boot(arch="aarch64",
                           options=["-M", "sbsa-ref",
                                    "-cpu", "cortex-a57",
                                    "-m", "512M",
                                    "-pflash", flash0,
                                    "-pflash", flash1,
                                    "-hda", hda])
        self.emulator.login()

        # Check the program can execute.
        self.assertRunOk("fwts --version")

        # We run a simple UEFI runtime service variable interface test
        # suite. Those tests are using the fwts efi_runtime kernel
        # module.
        self.assertRunOk("fwts -q uefirtvariable", timeout=30)

        # The previous fwts invocation is expected to have created a
        # "results.log" report. We check the file exists and contains
        # a known header string.
        expected_str = "Results generated by fwts:"
        cmd = f"grep -F '{expected_str}' results.log"
        out, ret = self.emulator.run(cmd)
        self.assertEqual(ret, 0)
        self.assertTrue(out[0].startswith(expected_str))
